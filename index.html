<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CareSummary (Demo)</title>

  <!-- Azure Speech SDK -->
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

  <!-- Avoid favicon 404 noise -->
  <link rel="icon" href="data:," />

  <style>
    :root{
      --bg:#071023; --text:#e8eefc; --muted:#9fb2d6;
      --border:rgba(255,255,255,.10); --good:#3ddc97; --warn:#ffd166; --bad:#ff5c7a;
      --btn:#12244a;
      --shadow:0 18px 60px rgba(0,0,0,.28);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(26,58,122,.40) 0%, rgba(26,58,122,0) 60%),
        radial-gradient(1100px 700px at 80% 0%, rgba(59,20,95,.35) 0%, rgba(59,20,95,0) 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1120px; margin:34px auto; padding:0 18px}
    .header{display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    h1{font-size:28px; margin:0}
    .pill{font-size:12px; color:#dbe7ff; background:rgba(122,166,255,.16); border:1px solid var(--border);
      padding:6px 10px; border-radius:999px}
    .sub{margin:8px 0 0; color:var(--muted); line-height:1.35}
    .panel{
      margin-top:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 220px 220px 240px 1fr;
    }
    @media (max-width: 1050px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width: 700px){ .grid{grid-template-columns:1fr} }

    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    select,input{
      width:100%;
      background:rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    select:disabled,input:disabled{opacity:.55}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      background:var(--btn);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
      transition:transform .05s ease, border-color .15s ease, background .15s ease;
    }
    button:hover{border-color:rgba(122,166,255,.55)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .primary{background:rgba(122,166,255,.18); border-color:rgba(122,166,255,.45)}
    .danger{background:rgba(255,92,122,.15); border-color:rgba(255,92,122,.45)}
    .status{
      margin-top:12px; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:rgba(0,0,0,.18); color:var(--muted);
      display:flex; align-items:center; gap:10px;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.35)}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .help{margin-top:10px; color:var(--muted); font-size:12px}
    .mono{font-family:var(--mono)}

    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px}
    @media (max-width: 900px){ .twocol{grid-template-columns:1fr;} }
    .card{
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:14px; color:#cfe0ff}
    textarea{
      width:100%;
      min-height:280px;
      resize:vertical;
      background:rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      outline:none;
      line-height:1.35;
      font-family:var(--mono);
      font-size:13px;
    }
    .smallnote{margin-top:8px; font-size:12px; color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1>CareSummary (Demo)</h1>
      <span class="pill">School project</span>
    </div>
    <p class="sub">
      Demo: record speech ‚Üí transcribe (Azure Speech) ‚Üí summary/report via Azure Function + Foundry model.
      <br><b>Do not use real patient data.</b>
    </p>

    <div class="panel">
      <div class="grid">
        <div>
          <label for="lang">Speech language</label>
          <select id="lang">
            <option value="sv-SE">Swedish ‚Äî sv-SE</option>
            <option value="en-US" selected>English (US) ‚Äî en-US</option>
            <option value="ar-SA">Arabic ‚Äî ar-SA</option>
          </select>
        </div>

        <div>
          <label for="outputMode">Output</label>
          <select id="outputMode">
            <option value="summary" selected>Summary (JSON/Text)</option>
            <option value="report">Report (HTML template)</option>
          </select>
        </div>

        <div>
          <label for="format">Note format (Summary)</label>
          <select id="format">
            <option>Bullet summary</option>
            <option>SOAP</option>
            <option>SBAR</option>
            <option>Narrative</option>
          </select>
        </div>

        <div>
          <label for="pid">Patient ID (demo)</label>
          <input id="pid" placeholder="Example: P-001 (optional)" />
        </div>

        <div>
          <label for="reportTemplate">Rapportmall (Report)</label>
          <select id="reportTemplate">
            <option>SOAP-journalanteckning</option>
            <option>SBAR-rapport (√∂verl√§mning)</option>
            <option>Journalanteckning (enkel)</option>
            <option>Rondanteckning</option>
            <option>Omv√•rdnadsrapport</option>
            <option>Utskrivningsanteckning</option>
          </select>
        </div>

        <div>
          <label for="reportLang">Rapportspr√•k (Report)</label>
          <select id="reportLang">
            <option value="sv" selected>Svenska</option>
            <option value="en">English</option>
          </select>
        </div>

        <div style="grid-column: span 2;">
          <div class="help mono" id="apiHint"></div>
        </div>
      </div>

      <div class="btnrow">
        <button id="btnTest" class="primary">üß™ Test API</button>
        <button id="btnStart" class="primary">üéôÔ∏è Start recording</button>
        <button id="btnStop" disabled>‚èπÔ∏è Stop</button>
        <button id="btnGenerate" class="primary">‚ú® Generate</button>
        <button id="btnClear" class="danger">üßπ Clear</button>
        <button id="btnCopyT">üìã Copy transcript</button>
        <button id="btnCopyO">üìã Copy output</button>
      </div>

      <div class="status" id="status">
        <span class="dot" id="dot"></span>
        <span id="statusText">Ready.</span>
      </div>

      <div class="smallnote">
        Summary uses <span class="mono">POST /SummarizeNote</span> (SOAP/SBAR supported).<br/>
        Report uses <span class="mono">POST /RenderReport</span> (SOAP or SBAR HTML template) and opens a new tab.
      </div>
    </div>

    <div class="twocol">
      <div class="card">
        <h3>Transcript (what was said)</h3>
        <textarea id="transcript" placeholder="Press Start recording and speak..."></textarea>
        <div class="smallnote">You can edit the transcript before generating.</div>
      </div>

      <div class="card">
        <h3>Output (Summary JSON/Text or Report status)</h3>
        <textarea id="output" placeholder="Press Generate..."></textarea>
        <div class="smallnote">For Report mode, a new tab opens with the HTML report (print/save as PDF).</div>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // CONFIG
    // ======================
    // If you later connect Functions as SWA backend, use:
    // const API_BASE = "/api";
    const API_BASE = "https://caresummary-api-feerbpb5b8gwf6cf.westeurope-01.azurewebsites.net/api";

    // ======================
    // DOM
    // ======================
    const el = (id) => document.getElementById(id);

    const lang = el("lang");
    const outputMode = el("outputMode");
    const format = el("format");
    const pid = el("pid");
    const reportTemplate = el("reportTemplate");
    const reportLang = el("reportLang");

    const transcript = el("transcript");
    const output = el("output");

    const btnTest = el("btnTest");
    const btnStart = el("btnStart");
    const btnStop = el("btnStop");
    const btnGenerate = el("btnGenerate");
    const btnClear = el("btnClear");
    const btnCopyT = el("btnCopyT");
    const btnCopyO = el("btnCopyO");

    const dot = el("dot");
    const statusText = el("statusText");
    el("apiHint").textContent = `API_BASE = ${API_BASE}`;

    // ======================
    // STATUS
    // ======================
    function setStatus(message, level = "neutral") {
      statusText.textContent = message;
      dot.className = "dot" + (level === "good" ? " good" : level === "warn" ? " warn" : level === "bad" ? " bad" : "");
      console.log("[STATUS]", level, message);
    }

    // ======================
    // LOCAL STORAGE
    // ======================
    const LS = {
      transcript: "caresummary.transcript",
      output: "caresummary.output",
      lang: "caresummary.lang",
      mode: "caresummary.mode",
      format: "caresummary.format",
      pid: "caresummary.pid",
      rtpl: "caresummary.reportTemplate",
      rlang: "caresummary.reportLang",
    };

    function loadSaved() {
      transcript.value = localStorage.getItem(LS.transcript) || "";
      output.value = localStorage.getItem(LS.output) || "";
      lang.value = localStorage.getItem(LS.lang) || lang.value;
      outputMode.value = localStorage.getItem(LS.mode) || outputMode.value;
      format.value = localStorage.getItem(LS.format) || format.value;
      pid.value = localStorage.getItem(LS.pid) || "";
      reportTemplate.value = localStorage.getItem(LS.rtpl) || reportTemplate.value;
      reportLang.value = localStorage.getItem(LS.rlang) || reportLang.value;
      applyModeUI();
    }

    function saveAll() {
      localStorage.setItem(LS.transcript, transcript.value || "");
      localStorage.setItem(LS.output, output.value || "");
      localStorage.setItem(LS.lang, lang.value);
      localStorage.setItem(LS.mode, outputMode.value);
      localStorage.setItem(LS.format, format.value);
      localStorage.setItem(LS.pid, pid.value || "");
      localStorage.setItem(LS.rtpl, reportTemplate.value);
      localStorage.setItem(LS.rlang, reportLang.value);
    }

    // ======================
    // MODE UI
    // ======================
    function applyModeUI() {
      const isSummary = outputMode.value === "summary";
      format.disabled = !isSummary;
      reportTemplate.disabled = isSummary;
      reportLang.disabled = isSummary;
    }

    // ======================
    // API helpers
    // ======================
    async function apiGet(path) {
      const r = await fetch(`${API_BASE}${path}`, { method:"GET", cache:"no-store" });
      const t = await r.text();
      if (!r.ok) throw new Error(`${path} failed (${r.status}): ${t}`);
      try { return JSON.parse(t); } catch { return t; }
    }

    async function apiPost(path, bodyObj) {
      const r = await fetch(`${API_BASE}${path}`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(bodyObj),
        cache:"no-store"
      });
      const t = await r.text();
      if (!r.ok) throw new Error(`${path} failed (${r.status}): ${t}`);
      try { return JSON.parse(t); } catch { return t; }
    }

    async function apiPostText(path, bodyObj) {
      const r = await fetch(`${API_BASE}${path}`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(bodyObj),
        cache:"no-store"
      });
      const t = await r.text();
      if (!r.ok) throw new Error(`${path} failed (${r.status}): ${t}`);
      return t;
    }

    // ======================
    // Speech recognition
    // ======================
    let recognizer = null;
    let isRecording = false;

    async function getSpeechToken() {
      // expects { token, region }
      return await apiGet("/speechToken");
    }

    async function startRecording() {
      if (isRecording) return;
      if (!window.SpeechSDK) {
        setStatus("Speech SDK not loaded. Refresh the page.", "bad");
        return;
      }

      setStatus("Requesting Speech token‚Ä¶", "warn");
      btnStart.disabled = true;
      btnStop.disabled = true;

      try {
        const { token, region } = await getSpeechToken();

        const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
        speechConfig.speechRecognitionLanguage = lang.value;

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        recognizer.recognized = (s, e) => {
          if (e.result && e.result.text) {
            transcript.value += (transcript.value ? "\n" : "") + e.result.text;
            saveAll();
          }
        };

        recognizer.canceled = (s, e) => {
          setStatus(`Speech canceled: ${e.errorDetails || "Unknown error"}`, "bad");
          stopRecording().catch(()=>{});
        };

        recognizer.sessionStopped = () => {
          stopRecording().catch(()=>{});
        };

        isRecording = true;
        btnStop.disabled = false;
        setStatus("Recording‚Ä¶ speak now.", "good");
        recognizer.startContinuousRecognitionAsync();
      } catch (err) {
        console.error(err);
        setStatus(err.message || String(err), "bad");
        btnStart.disabled = false;
        btnStop.disabled = true;
        isRecording = false;
        recognizer = null;
      }
    }

    async function stopRecording() {
      if (!isRecording) return;
      isRecording = false;

      btnStop.disabled = true;
      setStatus("Stopping‚Ä¶", "warn");

      if (!recognizer) {
        btnStart.disabled = false;
        setStatus("Stopped.", "good");
        return;
      }

      await new Promise((resolve) => {
        recognizer.stopContinuousRecognitionAsync(() => resolve(), () => resolve());
      });

      try { recognizer.close(); } catch {}
      recognizer = null;

      btnStart.disabled = false;
      setStatus("Stopped.", "good");
    }

    // ======================
    // Generate (Summary or Report)
    // ======================
    async function generate() {
      const note = transcript.value.trim();
      if (!note) {
        setStatus("Nothing to process. Record or paste transcript first.", "warn");
        return;
      }

      saveAll();

      const mode = outputMode.value;
      const patientId = (pid.value || "").trim();

      // ---- SUMMARY mode ----
      if (mode === "summary") {
        setStatus("Generating summary‚Ä¶", "warn");
        btnGenerate.disabled = true;

        try {
          const res = await apiPost("/SummarizeNote", {
            note,
            format: format.value,    // Bullet / SOAP / SBAR / Narrative
            patientId
          });

          output.value = (typeof res === "string") ? res : JSON.stringify(res, null, 2);
          saveAll();
          setStatus("Summary generated.", "good");
        } catch (err) {
          console.error(err);
          output.value = String(err.message || err);
          saveAll();
          setStatus("Summary failed. Check Function logs.", "bad");
        } finally {
          btnGenerate.disabled = false;
        }
        return;
      }

      // ---- REPORT mode ----
      setStatus("Generating report‚Ä¶", "warn");
      btnGenerate.disabled = true;

      try {
        const html = await apiPostText("/RenderReport", {
          transcript: note,
          patientId,
          template: reportTemplate.value, // SOAP-journalanteckning / SBAR-rapport...
          language: reportLang.value      // sv / en
        });

        const w = window.open("", "_blank");
        if (!w) {
          output.value = "Popup blocked. Allow popups and try again.";
          setStatus("Popup blocked.", "bad");
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();

        output.value = "‚úÖ Report opened in a new tab. Use Print ‚Üí Save as PDF.";
        saveAll();
        setStatus("Report generated.", "good");
      } catch (err) {
        console.error(err);
        output.value = String(err.message || err);
        saveAll();
        setStatus("Report failed. Check Function logs.", "bad");
      } finally {
        btnGenerate.disabled = false;
      }
    }

    // ======================
    // Utilities
    // ======================
    async function copyText(value) {
      await navigator.clipboard.writeText(value || "");
      setStatus("Copied to clipboard.", "good");
      setTimeout(() => setStatus("Ready.", "neutral"), 800);
    }

    function clearAll() {
      if (isRecording) stopRecording().catch(()=>{});
      transcript.value = "";
      output.value = "";
      pid.value = "";
      saveAll();
      setStatus("Cleared.", "good");
    }

    async function testApi() {
      setStatus("Testing API‚Ä¶", "warn");
      try {
        await apiGet("/speechToken");
        setStatus("OK: /speechToken reachable.", "good");

        // quick demo based on selected mode
        if (outputMode.value === "summary") {
          const demo = await apiPost("/SummarizeNote", {
            note: "Situation: Patienten beskriver huvudv√§rk i tre dagar. Ingen feber.",
            format: format.value,
            patientId: "P-TEST"
          });
          output.value = typeof demo === "string" ? demo : JSON.stringify(demo, null, 2);
          saveAll();
          setStatus("OK: SummarizeNote responded.", "good");
        } else {
          const html = await apiPostText("/RenderReport", {
            transcript: "Patienten beskriver huvudv√§rk i tre dagar. Ej feber. Sm√§rta 6/10.",
            patientId: "P-TEST",
            template: reportTemplate.value,
            language: reportLang.value
          });
          output.value = "‚úÖ RenderReport responded (HTML). Click Generate to open the report tab.";
          saveAll();
          setStatus("OK: RenderReport responded.", "good");
        }

      } catch (err) {
        console.error(err);
        output.value = String(err.message || err);
        saveAll();
        setStatus("API test failed.", "bad");
      }
    }

    // ======================
    // Events
    // ======================
    lang.addEventListener("change", saveAll);
    outputMode.addEventListener("change", () => { applyModeUI(); saveAll(); });
    format.addEventListener("change", saveAll);
    pid.addEventListener("input", saveAll);
    reportTemplate.addEventListener("change", saveAll);
    reportLang.addEventListener("change", saveAll);
    transcript.addEventListener("input", saveAll);

    btnTest.onclick = () => testApi();
    btnStart.onclick = () => startRecording().catch(e => setStatus(String(e.message||e), "bad"));
    btnStop.onclick = () => stopRecording().catch(e => setStatus(String(e.message||e), "bad"));
    btnGenerate.onclick = () => generate().catch(e => setStatus(String(e.message||e), "bad"));
    btnClear.onclick = () => clearAll();
    btnCopyT.onclick = () => copyText(transcript.value);
    btnCopyO.onclick = () => copyText(output.value);

    // Init
    loadSaved();
    setStatus("Ready.", "neutral");
  </script>
</body>
</html>
