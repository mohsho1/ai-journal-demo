module.exports = async function (context, req) {
    context.log('SummarizeNote HTTP trigger processed a request.');

    const note = (req.body && req.body.note) || "";
    const patientId = (req.body && req.body.patientId) || "";

    if (!note.trim()) {
        context.res = {
            status: 400,
            headers: { "Content-Type": "application/json" },
            body: { error: "Field 'note' is required in the request body." }
        };
        return;
    }

    // --- Simple local analysis (no AI) ---

    // Stats
    const length = note.length;
    const words = note.trim().split(/\s+/).filter(Boolean);
    const wordCount = words.length;

    // Very simple keyword detection
    const lower = note.toLowerCase();
    const symptomWords = [
        "pain",
        "headache",
        "fever",
        "cough",
        "shortness of breath",
        "nausea",
        "vomiting",
        "dizziness",
        "fatigue"
    ];
    const conditionWords = [
        "diabetes",
        "asthma",
        "hypertension",
        "heart failure",
        "depression",
        "anxiety"
    ];
    const medWords = [
        "paracetamol",
        "ibuprofen",
        "insulin",
        "metformin",
        "antibiotic",
        "inhaler"
    ];

    const symptoms = symptomWords.filter(w => lower.includes(w));
    const conditions = conditionWords.filter(w => lower.includes(w));
    const meds = medWords.filter(w => lower.includes(w));

    let mainSymptom = "";
    if (symptoms.length > 0) {
        mainSymptom = symptoms[0];
    }

    // Simple risk tags
    const riskTags = [];
    if (lower.includes("suicid") || lower.includes("self-harm") || lower.includes("harm myself")) {
        riskTags.push("suicide / self-harm risk");
    }
    if (lower.includes("chest pain") || lower.includes("severe pain")) {
        riskTags.push("possible acute pain");
    }
    if (lower.includes("high fever") || lower.includes("39°") || lower.includes("40°")) {
        riskTags.push("high fever");
    }

    const patientLabel = patientId || "example (no identifier provided)";

    // --- Build simple, non-AI summary texts ---

    const general = `Approx. length: ${wordCount} words (${length} characters).`;

    let assessmentParts = [];
    if (mainSymptom) {
        assessmentParts.push(`Main recorded symptom: ${mainSymptom}.`);
    }
    if (conditions.length > 0) {
        assessmentParts.push(`Mentioned conditions: ${conditions.join(", ")}.`);
    }
    if (riskTags.length > 0) {
        assessmentParts.push(`Potential risk tags detected: ${riskTags.join(", ")}.`);
    }
    if (assessmentParts.length === 0) {
        assessmentParts.push("No specific symptoms or conditions were automatically detected in this prototype.");
    }
    assessmentParts.push("This is a simple prototype analysis. All clinical reasoning must be done by the clinician.");
    const assessment = assessmentParts.join(" ");

    const plan =
        "Prototype plan: this system only helps structure the note. " +
        "Any medical decisions (investigations, treatment, follow-up) must be decided by the clinician. " +
        "In a future version, an AI/LLM could suggest a more detailed plan, but always as decision support – not as a final diagnosis.";

    // --- Response payload ---
    const responseBody = {
        patientId: patientLabel,
        stats: {
            characters: length,
            words: wordCount
        },
        keywords: {
            symptoms,
            conditions,
            medications: meds,
            riskTags,
            mainSymptom: mainSymptom || null
        },
        general,
        assessment,
        plan
    };

    context.res = {
        status: 200,
        headers: { "Content-Type": "application/json" },
        body: responseBody
    };
};
