<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CareSummary (Demo) ‚Äì Voice to Clinical Note</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2e;
      --muted: #9fb0d0;
      --text: #e8eefc;
      --accent: #6ea8fe;
      --danger: #ff6b6b;
      --ok: #51cf66;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #15284e 0%, var(--bg) 55%), var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 28px 18px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.2px;
    }
    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      line-height: 1.4;
      font-size: 14px;
      max-width: 900px;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 18px 40px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .grid2 {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }
    @media (max-width: 900px) {
      .grid2 { grid-template-columns: 1fr; }
    }
    .card {
      background: rgba(17,27,46,0.92);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      align-items: end;
    }
    .field { grid-column: span 3; }
    .field.wide { grid-column: span 6; }
    .field.full { grid-column: span 12; }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 100%;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
    }
    textarea {
      min-height: 180px;
      resize: vertical;
      line-height: 1.45;
    }
    .btnbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.03s ease, background 0.15s ease, border-color 0.15s ease;
    }
    button:hover { background: rgba(255,255,255,0.09); }
    button:active { transform: translateY(1px); }
    button.primary {
      background: rgba(110,168,254,0.18);
      border-color: rgba(110,168,254,0.45);
    }
    button.danger {
      background: rgba(255,107,107,0.12);
      border-color: rgba(255,107,107,0.40);
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.20);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.05);
      flex: 0 0 auto;
    }
    .dot.ok { background: var(--ok); box-shadow: 0 0 0 4px rgba(81,207,102,0.12); }
    .dot.bad { background: var(--danger); box-shadow: 0 0 0 4px rgba(255,107,107,0.12); }
    .dot.live { background: var(--accent); box-shadow: 0 0 0 4px rgba(110,168,254,0.12); }
    .small {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.4;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(110,168,254,0.12);
      border: 1px solid rgba(110,168,254,0.28);
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<header>
  <h1>CareSummary (Demo) <span class="pill">School project</span></h1>
  <p class="subtitle">
    Demo app: record speech ‚Üí transcribe with <b>Azure Speech</b> ‚Üí send text to your <b>Azure Function</b> to summarize into a clinical note.
    <br><b>Do not use real patient data.</b>
  </p>
</header>

<div class="wrap">

  <div class="card">
    <div class="row">
      <div class="field">
        <label for="language">Speech language</label>
        <select id="language">
          <option value="en-US" selected>English (US) ‚Äì en-US</option>
          <option value="en-GB">English (UK) ‚Äì en-GB</option>
          <option value="sv-SE">Swedish ‚Äì sv-SE</option>
          <option value="ar-SA">Arabic ‚Äì ar-SA</option>
        </select>
      </div>

      <div class="field">
        <label for="noteFormat">Note format</label>
        <select id="noteFormat">
          <option value="narrative" selected>Narrative</option>
          <option value="soap">SOAP</option>
          <option value="bullet">Bullet summary</option>
        </select>
      </div>

      <div class="field wide">
        <label for="patientId">Patient ID (demo)</label>
        <input id="patientId" placeholder="Example: P-001 (optional)" />
      </div>

      <div class="field full">
        <div class="btnbar">
          <button id="btnTest" class="primary">Test API</button>
          <button id="btnStart" class="primary">üéôÔ∏è Start recording</button>
          <button id="btnStop" disabled>‚èπÔ∏è Stop</button>
          <button id="btnSummarize" class="primary">‚ú® Summarize</button>
          <button id="btnClear" class="danger">üßπ Clear</button>
          <button id="btnCopyTranscript">Copy transcript</button>
          <button id="btnCopySummary">Copy summary</button>
        </div>

        <div class="status" id="statusBox">
          <div class="dot" id="statusDot"></div>
          <div id="statusText">Ready.</div>
        </div>

        <div class="small">
          <span class="mono">API_BASE</span> is configured in the code (top of script). Your token is fetched from <span class="mono">/speechToken</span>.
        </div>
      </div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <label for="transcript"><b>Transcript</b> (what was said)</label>
      <textarea id="transcript" placeholder="Press Start recording, speak, then Stop. The transcript will appear here..."></textarea>
      <div class="small" id="partialHint"></div>
    </div>

    <div class="card">
      <label for="summary"><b>Summary / Clinical note</b> (from AI)</label>
      <textarea id="summary" placeholder="Press Summarize to generate a clinical note..."></textarea>
      <div class="small">
        This output is for demo only. Always review and edit.
      </div>
    </div>
  </div>
</div>

<!-- Speech SDK (browser bundle) -->
<script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@1.38.0/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

<script>
  /***************************************************************
   * CONFIG (EDIT THIS ONLY IF YOUR FUNCTION HOST CHANGES)
   ***************************************************************/
  const API_BASE = "https://caresummary-api-feerbpb5b8gwf6cf.westeurope-01.azurewebsites.net/api";
  // Your backend function route name (Azure Functions is usually the function name)
  // We'll try both /SummarizeNote and /summarizeNote automatically.
  const SUMMARY_PATHS = ["SummarizeNote", "summarizeNote"];

  /***************************************************************
   * UI helpers
   ***************************************************************/
  const $ = (id) => document.getElementById(id);
  const statusDot = $("statusDot");
  const statusText = $("statusText");

  function setStatus(msg, kind = "idle") {
    statusText.textContent = msg;
    statusDot.classList.remove("ok", "bad", "live");
    if (kind === "ok") statusDot.classList.add("ok");
    else if (kind === "bad") statusDot.classList.add("bad");
    else if (kind === "live") statusDot.classList.add("live");
  }

  function appendTranscript(text) {
    const box = $("transcript");
    const sep = box.value && !box.value.endsWith("\n") ? "\n" : "";
    box.value = box.value + sep + text;
    box.scrollTop = box.scrollHeight;
  }

  async function copyToClipboard(text) {
    await navigator.clipboard.writeText(text);
  }

  /***************************************************************
   * Speech (mic ‚Üí text)
   ***************************************************************/
  let recognizer = null;
  let isRecording = false;

  async function getSpeechToken() {
    const r = await fetch(`${API_BASE}/speechToken`, { method: "GET" });
    if (!r.ok) throw new Error(`speechToken failed: HTTP ${r.status}`);
    return await r.json(); // { token, region }
  }

  async function startRecording() {
    if (isRecording) return;

    // Basic checks
    if (!window.SpeechSDK) {
      setStatus("Speech SDK not loaded. Check the script tag / network.", "bad");
      return;
    }

    setStatus("Requesting token...", "live");

    const lang = $("language").value;

    let tokenData;
    try {
      tokenData = await getSpeechToken();
    } catch (e) {
      console.error(e);
      setStatus("Token request failed. Check API_BASE, CORS, and Function status.", "bad");
      return;
    }

    try {
      const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(tokenData.token, tokenData.region);
      speechConfig.speechRecognitionLanguage = lang;

      // Optional: nicer punctuation / formatting where supported
      try {
        speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceResponse_PostProcessingOption, "TrueText");
      } catch {}

      const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
      recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

      $("partialHint").textContent = "";

      recognizer.recognizing = (s, e) => {
        if (e.result && e.result.text) {
          $("partialHint").textContent = "Listening‚Ä¶ " + e.result.text;
        }
      };

      recognizer.recognized = (s, e) => {
        if (e.result && e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
          const text = (e.result.text || "").trim();
          if (text) appendTranscript(text);
        }
      };

      recognizer.canceled = (s, e) => {
        console.warn("Speech canceled:", e);
        setStatus("Recognition canceled. Check mic permissions and Speech resource.", "bad");
        stopRecording();
      };

      recognizer.sessionStopped = () => {
        stopRecording();
      };

      recognizer.startContinuousRecognitionAsync(
        () => {
          isRecording = true;
          $("btnStart").disabled = true;
          $("btnStop").disabled = false;
          setStatus("Recording‚Ä¶ speak now.", "live");
        },
        (err) => {
          console.error(err);
          setStatus("Failed to start recognition. Check mic permission.", "bad");
        }
      );
    } catch (e) {
      console.error(e);
      setStatus("Could not access microphone / start Speech. Allow mic permission.", "bad");
    }
  }

  function stopRecording() {
    $("partialHint").textContent = "";

    if (!recognizer) {
      isRecording = false;
      $("btnStart").disabled = false;
      $("btnStop").disabled = true;
      setStatus("Ready.", "ok");
      return;
    }

    recognizer.stopContinuousRecognitionAsync(
      () => {
        recognizer.close();
        recognizer = null;
        isRecording = false;
        $("btnStart").disabled = false;
        $("btnStop").disabled = true;
        setStatus("Stopped. You can summarize now.", "ok");
      },
      (err) => {
        console.error(err);
        // Still try to cleanup
        try { recognizer.close(); } catch {}
        recognizer = null;
        isRecording = false;
        $("btnStart").disabled = false;
        $("btnStop").disabled = true;
        setStatus("Stopped (with warnings).", "ok");
      }
    );
  }

  /***************************************************************
   * Summarize (text ‚Üí AI note via your Function)
   ***************************************************************/
  async function postSummarize(note, patientId, noteFormat) {
    const payload = {
      note,
      patientId: patientId || "",
      format: noteFormat || "narrative"
    };

    // Try both possible route names (case differences)
    let lastErr = null;
    for (const p of SUMMARY_PATHS) {
      try {
        const r = await fetch(`${API_BASE}/${p}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!r.ok) {
          const txt = await r.text().catch(() => "");
          throw new Error(`Summarize HTTP ${r.status} on /${p}. ${txt}`);
        }
        return await r.json().catch(async () => ({ text: await r.text() }));
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("Summarize failed.");
  }

  async function summarizeNow() {
    const note = $("transcript").value.trim();
    if (!note) {
      setStatus("Transcript is empty. Record something first.", "bad");
      return;
    }
    if (isRecording) {
      setStatus("Stop recording before summarizing.", "bad");
      return;
    }

    const patientId = $("patientId").value.trim();
    const format = $("noteFormat").value;

    $("btnSummarize").disabled = true;
    setStatus("Summarizing‚Ä¶", "live");

    try {
      const data = await postSummarize(note, patientId, format);

      // Your backend might return { summary: "..."} or { note: "..."} or raw text.
      const possible =
        data.summary ||
        data.note ||
        data.result ||
        data.text ||
        (typeof data === "string" ? data : JSON.stringify(data, null, 2));

      $("summary").value = String(possible).trim();
      setStatus("Summary generated.", "ok");
    } catch (e) {
      console.error(e);
      setStatus("Summarize failed. Check Function route/name + logs.", "bad");
      $("summary").value = "";
    } finally {
      $("btnSummarize").disabled = false;
    }
  }

  /***************************************************************
   * Clear + Test
   ***************************************************************/
  function clearAll() {
    $("transcript").value = "";
    $("summary").value = "";
    $("partialHint").textContent = "";
    setStatus("Cleared.", "ok");
  }

  async function testApi() {
    setStatus("Testing API‚Ä¶", "live");
    try {
      const r = await fetch(`${API_BASE}/speechToken`);
      if (!r.ok) throw new Error("HTTP " + r.status);
      await r.json();
      setStatus("API OK ‚úÖ speechToken reachable.", "ok");
      alert("API OK ‚úÖ (speechToken works)");
    } catch (e) {
      console.error(e);
      setStatus("API test failed. Check API_BASE + CORS + Function running.", "bad");
      alert("API test failed ‚ùå. Open DevTools Console for details.");
    }
  }

  /***************************************************************
   * Wire up buttons
   ***************************************************************/
  $("btnStart").addEventListener("click", startRecording);
  $("btnStop").addEventListener("click", stopRecording);
  $("btnSummarize").addEventListener("click", summarizeNow);
  $("btnClear").addEventListener("click", clearAll);
  $("btnTest").addEventListener("click", testApi);

  $("btnCopyTranscript").addEventListener("click", async () => {
    try {
      await copyToClipboard($("transcript").value);
      setStatus("Transcript copied.", "ok");
    } catch {
      setStatus("Copy failed (browser blocked clipboard).", "bad");
    }
  });

  $("btnCopySummary").addEventListener("click", async () => {
    try {
      await copyToClipboard($("summary").value);
      setStatus("Summary copied.", "ok");
    } catch {
      setStatus("Copy failed (browser blocked clipboard).", "bad");
    }
  });

  // Cleanup
  window.addEventListener("beforeunload", () => {
    try { stopRecording(); } catch {}
  });

  setStatus("Ready.", "ok");
</script>
</body>
</html>
