<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CareSummary Demo</title>

  <!-- Speech SDK for JavaScript (browser bundle) -->
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

  <style>
    body { font-family: system-ui, Arial; margin: 24px; max-width: 900px; }
    button { padding: 10px 14px; margin-right: 8px; cursor: pointer; }
    textarea { width: 100%; height: 180px; margin-top: 10px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .status { padding: 6px 10px; background: #f2f2f2; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>CareSummary (School Demo)</h1>

  <div class="row">
    <button id="btnStart">ğŸ™ï¸ Start</button>
    <button id="btnStop" disabled>ğŸ›‘ Stop</button>
    <button id="btnClear">ğŸ§¹ Clear</button>

    <label>
      Language:
      <select id="lang">
        <option value="sv-SE">Swedish (sv-SE)</option>
        <option value="en-US">English (en-US)</option>
      </select>
    </label>

    <div class="status" id="status">Idle</div>
  </div>

  <h3>Live transcript</h3>
  <textarea id="transcript" placeholder="Speech will appear here..."></textarea>

  <script>
    // âœ… Your Function App base (working host)
    const API_BASE = "https://caresummary-api-feerbpb5b8gwf6cf.westeurope-01.azurewebsites.net/api";

    let recognizer = null;

    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnClear = document.getElementById("btnClear");
    const transcriptEl = document.getElementById("transcript");
    const statusEl = document.getElementById("status");
    const langEl = document.getElementById("lang");

    function setStatus(msg) { statusEl.textContent = msg; }

    async function getSpeechToken() {
      const r = await fetch(`${API_BASE}/speechToken`, { method: "GET" });
      if (!r.ok) throw new Error(`speechToken failed: ${r.status}`);
      return await r.json(); // { token, region }
    }

    function appendText(t) {
      transcriptEl.value += (transcriptEl.value ? " " : "") + t;
      transcriptEl.scrollTop = transcriptEl.scrollHeight;
    }

    async function startListening() {
      btnStart.disabled = true;
      btnStop.disabled = false;
      setStatus("Getting token...");

      const { token, region } = await getSpeechToken();

      setStatus("Starting microphone... (allow permission)");
      const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
      speechConfig.speechRecognitionLanguage = langEl.value;

      const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
      recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

      recognizer.recognized = (s, e) => {
        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text) {
          appendText(e.result.text);
        }
      };

      recognizer.canceled = (s, e) => {
        setStatus(`Canceled: ${e.errorDetails || e.reason}`);
        stopListening();
      };

      recognizer.sessionStopped = () => {
        setStatus("Stopped.");
        stopListening();
      };

      recognizer.startContinuousRecognitionAsync(
        () => setStatus("Listening... speak now"),
        (err) => {
          setStatus("Start error: " + err);
          stopListening();
        }
      );
    }

    function stopListening() {
      btnStart.disabled = false;
      btnStop.disabled = true;

      if (!recognizer) return;

      recognizer.stopContinuousRecognitionAsync(() => {
        recognizer.close();
        recognizer = null;
      });
    }

    // Buttons
    btnStart.addEventListener("click", () => startListening().catch(err => {
      console.error(err);
      setStatus("ERROR: " + err.message);
      btnStart.disabled = false;
      btnStop.disabled = true;
    }));

    btnStop.addEventListener("click", stopListening);

    btnClear.addEventListener("click", () => {
      // stop mic (recommended) then clear text
      stopListening();
      transcriptEl.value = "";
      setStatus("Cleared.");
    });
  </script>
</body>
</html>
