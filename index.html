<script>
    // ðŸ‘‰ Din Azure Function (SummarizeNote)
    const API_URL = "https://caresummary-api-feerbpb5b8gwf6cf.westeurope-01.azurewebsites.net/api/SummarizeNote";

    // --- Voice recognition (browser only) ---
    let recognition = null;
    let isRecording = false;
    let fullTranscript = "";

    function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            const status = document.getElementById('recStatus');
            status.innerHTML = "Speech recognition is not supported in this browser. Please use Chrome or Edge for this demo.";
            document.getElementById('startRecBtn').disabled = true;
            document.getElementById('stopRecBtn').disabled = true;
            return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isRecording = true;
            const dot = document.getElementById('statusDot');
            dot.classList.add('active');
            document.getElementById('recStatus').innerHTML =
                '<span class="status-dot active"></span>Listening... please dictate your note.';
            document.getElementById('startRecBtn').disabled = true;
            document.getElementById('stopRecBtn').disabled = false;
        };

        recognition.onend = () => {
            isRecording = false;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('recStatus').innerHTML =
                '<span class="status-dot"></span>Recording stopped. You can review the transcript or record again.';
            document.getElementById('startRecBtn').disabled = false;
            document.getElementById('stopRecBtn').disabled = true;
        };

        recognition.onerror = (event) => {
            isRecording = false;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('recStatus').innerHTML =
                '<span class="status-dot"></span>Error: ' + (event.error || 'unknown error');
            document.getElementById('startRecBtn').disabled = false;
            document.getElementById('stopRecBtn').disabled = true;
        };

        recognition.onresult = (event) => {
            let interim = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    fullTranscript += transcript + " ";
                } else {
                    interim += transcript;
                }
            }
            updateTranscriptBox(fullTranscript, interim);
        };
    }

    function updateTranscriptBox(finalText, interimText) {
        const placeholder = document.getElementById('transcriptPlaceholder');
        const textSpan = document.getElementById('transcriptText');

        if (!finalText && !interimText) {
            placeholder.style.display = "inline";
            textSpan.style.display = "none";
            textSpan.textContent = "";
            return;
        }

        placeholder.style.display = "none";
        textSpan.style.display = "inline";
        textSpan.textContent = (finalText + " " + (interimText || "")).trim();
    }

    function startRecording() {
        if (!recognition) {
            initSpeechRecognition();
        }
        if (recognition && !isRecording) {
            fullTranscript = "";
            updateTranscriptBox("", "");
            recognition.start();
        }
    }

    function stopRecording() {
        if (recognition && isRecording) {
            recognition.stop();
        }
    }

    function sendTranscriptToNote() {
        const transcriptEl = document.getElementById('transcriptText');
        const noteEl = document.getElementById('note');
        const text = transcriptEl.textContent.trim();

        if (!text) {
            alert("There is no transcript yet. Please record something first.");
            return;
        }

        if (noteEl.value.trim()) {
            noteEl.value += "\n\n--- From voice capture ---\n" + text;
        } else {
            noteEl.value = text;
        }
        noteEl.focus();
    }

    function clearTranscript() {
        fullTranscript = "";
        updateTranscriptBox("", "");
        document.getElementById('recStatus').innerHTML =
            '<span class="status-dot"></span>Transcript cleared. You can start a new recording.';
    }

    // --- Call Azure Function for summary ---
    async function generateSummary() {
        const noteEl = document.getElementById('note');
        const patientIdEl = document.getElementById('patientId');
        const output = document.getElementById('summaryOutput');
        const btn = document.getElementById('generateBtn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btnText');
        const errorEl = document.getElementById('apiError');

        errorEl.style.display = "none";
        errorEl.textContent = "";

        const note = noteEl.value.trim();
        const patientId = patientIdEl.value.trim();

        if (!note) {
            output.innerHTML = '<p class="empty-state">Please enter a clinical note (or use voice capture) before generating a summary.</p>';
            return;
        }

        btn.disabled = true;
        spinner.style.display = 'inline-block';
        btnText.textContent = 'Generating...';

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ note, patientId })
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(`API error ${response.status}: ${text}`);
            }

            const data = await response.json();
            renderSummary(data);
        } catch (err) {
            console.error(err);
            errorEl.style.display = "block";
            errorEl.textContent = "Failed to call backend API: " + err.message;
            output.innerHTML = '<p class="empty-state">Could not generate summary. Please try again or check the Function.</p>';
        } finally {
            btn.disabled = false;
            spinner.style.display = 'none';
            btnText.textContent = 'Generate summary';
        }
    }

    function renderSummary(data) {
        const output = document.getElementById('summaryOutput');

        let general = "";
        if (data.general) {
            general = data.general;
        } else if (data.stats) {
            const w = data.stats.words ?? "?";
            const c = data.stats.characters ?? "?";
            general = `Approx. length: ${w} words (${c} characters).`;
        }

        const assessment = data.assessment || "Prototype assessment based on simple logic in the Azure Function.";
        const plan = data.plan || "In a future version, this will be generated by an LLM in a secure backend.";

        output.innerHTML = `
            <div class="summary-section">
                <h3>General</h3>
                <p>${escapeHtml(general)}</p>
            </div>
            <div class="summary-section">
                <h3>Assessment</h3>
                <p>${escapeHtml(assessment)}</p>
            </div>
            <div class="summary-section">
                <h3>Plan</h3>
                <p>${escapeHtml(plan)}</p>
            </div>
        `;
    }

    function escapeHtml(str) {
        if (!str) return "";
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    function clearForm() {
        document.getElementById('patientId').value = "";
        document.getElementById('note').value = "";
        document.getElementById('summaryOutput').innerHTML =
            '<p class="empty-state">No summary yet. Enter a clinical note or record a spoken note, then click <strong>Generate summary</strong>.</p>';
        const errorEl = document.getElementById('apiError');
        if (errorEl) {
            errorEl.style.display = "none";
            errorEl.textContent = "";
        }
        clearTranscript();
    }

    window.addEventListener('load', initSpeechRecognition);
</script>
